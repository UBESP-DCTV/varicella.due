test_that("expand_prepost_positive works", {
  # setup
  db_gold <- tibble::tribble(
    ~ id_medico, ~n_paz, ~anno, ~class,
    1, 1, 2005L, "is_was_positive",
    2, 1, 2005L, "is_was_positive",
    1, 2, 2008L, "is_was_positive",
    3, 3, 2007L, "is_was_positive"
  )

  pop <- data.frame(
    id_medico = c(1, 2, 1, 3, 3),
    n_paz = c(1, 1, 2, 3, 4),
    foo = "bar"
  )

  expected <- tibble::tribble(
    ~id_medico, ~n_paz, ~anno,            ~class,
    1,      1, 2004L,        "negative",
    1,      1, 2004L,        "negative",
    1,      1, 2005L, "is_was_positive",
    1,      1, 2005L, "is_was_positive",
    1,      1, 2006L, "is_was_positive",
    1,      1, 2006L, "is_was_positive",
    1,      1, 2007L, "is_was_positive",
    1,      1, 2007L, "is_was_positive",
    1,      1, 2008L, "is_was_positive",
    1,      1, 2008L, "is_was_positive",
    1,      1, 2009L, "is_was_positive",
    1,      1, 2009L, "is_was_positive",
    1,      1, 2010L, "is_was_positive",
    1,      1, 2010L, "is_was_positive",
    1,      1, 2011L, "is_was_positive",
    1,      1, 2011L, "is_was_positive",
    1,      1, 2012L, "is_was_positive",
    1,      1, 2012L, "is_was_positive",
    1,      1, 2013L, "is_was_positive",
    1,      1, 2013L, "is_was_positive",
    1,      1, 2014L, "is_was_positive",
    1,      1, 2014L, "is_was_positive",
    2,      1, 2004L,        "negative",
    2,      1, 2004L,        "negative",
    2,      1, 2005L, "is_was_positive",
    2,      1, 2005L, "is_was_positive",
    2,      1, 2006L, "is_was_positive",
    2,      1, 2006L, "is_was_positive",
    2,      1, 2007L, "is_was_positive",
    2,      1, 2007L, "is_was_positive",
    2,      1, 2008L, "is_was_positive",
    2,      1, 2008L, "is_was_positive",
    2,      1, 2009L, "is_was_positive",
    2,      1, 2009L, "is_was_positive",
    2,      1, 2010L, "is_was_positive",
    2,      1, 2010L, "is_was_positive",
    2,      1, 2011L, "is_was_positive",
    2,      1, 2011L, "is_was_positive",
    2,      1, 2012L, "is_was_positive",
    2,      1, 2012L, "is_was_positive",
    2,      1, 2013L, "is_was_positive",
    2,      1, 2013L, "is_was_positive",
    2,      1, 2014L, "is_was_positive",
    2,      1, 2014L, "is_was_positive",
    1,      2, 2004L,        "negative",
    1,      2, 2004L,        "negative",
    1,      2, 2005L,        "negative",
    1,      2, 2005L,        "negative",
    1,      2, 2006L,        "negative",
    1,      2, 2006L,        "negative",
    1,      2, 2007L,        "negative",
    1,      2, 2007L,        "negative",
    1,      2, 2008L, "is_was_positive",
    1,      2, 2008L, "is_was_positive",
    1,      2, 2009L, "is_was_positive",
    1,      2, 2009L, "is_was_positive",
    1,      2, 2010L, "is_was_positive",
    1,      2, 2010L, "is_was_positive",
    1,      2, 2011L, "is_was_positive",
    1,      2, 2011L, "is_was_positive",
    1,      2, 2012L, "is_was_positive",
    1,      2, 2012L, "is_was_positive",
    1,      2, 2013L, "is_was_positive",
    1,      2, 2013L, "is_was_positive",
    1,      2, 2014L, "is_was_positive",
    1,      2, 2014L, "is_was_positive",
    3,      3, 2004L,        "negative",
    3,      3, 2004L,        "negative",
    3,      3, 2005L,        "negative",
    3,      3, 2005L,        "negative",
    3,      3, 2006L,        "negative",
    3,      3, 2006L,        "negative",
    3,      3, 2007L, "is_was_positive",
    3,      3, 2007L, "is_was_positive",
    3,      3, 2008L, "is_was_positive",
    3,      3, 2008L, "is_was_positive",
    3,      3, 2009L, "is_was_positive",
    3,      3, 2009L, "is_was_positive",
    3,      3, 2010L, "is_was_positive",
    3,      3, 2010L, "is_was_positive",
    3,      3, 2011L, "is_was_positive",
    3,      3, 2011L, "is_was_positive",
    3,      3, 2012L, "is_was_positive",
    3,      3, 2012L, "is_was_positive",
    3,      3, 2013L, "is_was_positive",
    3,      3, 2013L, "is_was_positive",
    3,      3, 2014L, "is_was_positive",
    3,      3, 2014L, "is_was_positive",
    3,      4, 2004L,        "negative",
    3,      4, 2005L,        "negative",
    3,      4, 2006L,        "negative",
    3,      4, 2007L,        "negative",
    3,      4, 2008L,        "negative",
    3,      4, 2009L,        "negative",
    3,      4, 2010L,        "negative",
    3,      4, 2011L,        "negative",
    3,      4, 2012L,        "negative",
    3,      4, 2013L,        "negative",
    3,      4, 2014L,        "negative"
  ) |>
    dplyr::mutate(
      class = class |>
        factor(levels = c("negative", "is_was_positive"))
    )

  # eval
  res <- expand_prepost_positive(db_gold, pop)

  # test
  expect_equal(res, expected)
})
